import{f as e,ah as a,bv as s,v as t,ak as l,bO as i,Q as o,R as n,bP as r,y as u,m as d,I as c,a0 as p,cN as m,al as v,bs as f,cv as b,br as h,bX as _,g,bM as x,r as k,P as w,n as y,gM as N,U as j,am as S,i as T,c as A,o as $,a as F,b as C,K as E,B as I,w as R,d as P,t as W,aE as z,s as V,F as M,D as O,e as U,a6 as B,a5 as L,C as H,$ as D,G,ag as Q,H as q,J,aO as K,cn as X,ad as Y,bR as Z,bS as ee,bT as ae,bV as se,bW as te,bY as le,bZ as ie}from"./BYaUYrp3.js";import{_ as oe}from"./ml8nxvr3.js";import{E as ne}from"./BPqlXwqI.js";import{_ as re}from"./BRtJHuoe.js";import{r as ue,u as de}from"./X1xoQqTK.js";import{b as ce}from"./rpf-pqgO.js";import{u as pe}from"./C58fLmiL.js";import"./LAamq4cb.js";import"./BRpM0hlH.js";import"./CmhOgDxg.js";import"./J5O7_dcT.js";import"./YMS0lBpe.js";import"./95DCypv_.js";import"./DmwBF0bq.js";import"./CtqcrtEU.js";import"./CMAkCGHu.js";import"./BZG75vlB.js";import"./C8xICoRm.js";import"./CiBdSA5g.js";import"./DI4fx9Xt.js";import"./_R2nDvl_.js";import"./DErwBm74.js";import"./VJjMdd4b.js";import"./KMvnDEkh.js";import"./CeKc5CNo.js";import"./DuTiG9mY.js";import"./CvCFBQRY.js";import"./qbnN7bu1.js";const me={class:"flex justify-between items-center mt-10px pr-15px"},ve=["infinite-scroll-disabled"],fe={class:"pr-10px pb-20px"},be={class:"flex-[1.5] flex items-center"},he={class:"ml-6px"},_e={class:"flex"},ge={class:"color-[var(--main-text)]"},xe={class:"mt-2px color-[--third-text]"},ke={class:"flex-1 flex flex-col items-end"},we={class:"flex-1 flex justify-end"},ye={key:1,class:"color-[var(--d-EAECEF-l-333)]"},Ne={key:0,class:"color-#959a9f text-12px text-center"},je=e({__name:"positionsTable",props:{height:{type:[Number,String],default:370}},setup(e){const{updateHolderNum:je}=a(s()),{t:Se}=t(),Te=l(),Ae=i(),$e=o(),Fe=ce(),Ce=pe(),Ee=n(),Ie=r(),{hide_risk:Re,hide_small:Pe}=a(u());function We(){Je.value.pageNo=1,Je.value.finished=!1}d((()=>Te.wsResult[v.PRICEV2]),(e=>{const a={};e.prices.forEach((e=>{a[e.token+"-"+e.chain]=e})),Ke.value=Ke.value.map((e=>{const s=a[e.index];if(s&&s.uprice>0){const a="--"===e.total_profit||0===Number(e.total_profit),t=new p(e.balance||0).times(s.uprice||0);if(a)return{...e,current_price_usd:s.uprice,balance_usd:t.toNumber()};{const a=new p(e.balance_usd||0).minus(e.total_profit||0),l=t.minus(a),i=new p(s.uprice||0).minus(e.average_purchase_price_usd||0).div(e.average_purchase_price_usd);return i.toNumber()<-1||Number(e.average_purchase_price_usd)<0?e:{...e,current_price_usd:s.uprice,balance_usd:t.toNumber(),total_profit:l.toFixed(),total_profit_ratio:i.toFixed()}}}return e})),m(Ke)})),d((()=>je.value),(()=>{We(),He()})),d((()=>Te.wsResult[v.ASSET]),(e=>{var a;if(e.swap){const a="So11111111111111111111111111111111111111112"===e.swap.token||e.swap.token===b?b:e.swap.token,s=e.swap.chain;a&&s&&setTimeout((()=>{We(),He()}),5e3)}else if(e.transfer){const s=e.transfer.chain,t=e.transfer.token,l=e.transfer.type;if(t&&s){const i=Ke.value.findIndex((e=>e.token===t&&e.chain===s)),o="0"===l;if(i>-1){const s=Ke.value[i],t=Number(s.balance),l=s.current_price_usd,n=new p(t).plus(o?e.transfer.amount:-(null==(a=e.transfer)?void 0:a.amount)),r=n.multipliedBy(l);s.balance=n.toString(),s.balance_usd=r.toNumber(),m(Ke)}else setTimeout((()=>{We(),He()}),5e3)}}})),h((function(e,a){const s=$e.getWalletAddress(a);s&&_({chain:a,walletAddress:s,tokens:[e]}).then((s=>{Ke.value=Ke.value.map((t=>t.token===e&&t.chain===a?{...t,balance:s[0].balance,balance_usd:new p(s[0].balance||0).times(t.current_price_usd||0).toNumber()}:{...t}))}))}),1e3,!1,!0);const ze=g((()=>{var e;return"evm"===(null==(e=x(Ee.chain))?void 0:e.vm_type)})),Ve=g((()=>$e.userInfo?$e.userInfo.addresses.map((({address:e,chain:a})=>e+"-"+a)):Ee.address&&ze.value&&"WatchWallet"!==Ee.walletName?[Ee.address+"-bsc",Ee.address+"-base",Ee.address+"-eth"]:[Ee.address+"-"+Ee.chain]));d((()=>Ve.value),(()=>{Me.value.user_ids=Ve.value}));const Me=k({hide_risk:Re,hide_small:Pe,user_ids:Ve.value}),Oe=k({}),Ue=e,Be=g((()=>Number(Ue.height)-110)),Le=w("scrollContainerRef"),He=f((()=>{const{value:e}=Le;e&&e.scrollHeight<=e.clientHeight&&!Je.value.finished&&Xe()}),200);d(Be,He);const De=c({sortBy:void 0,activeSort:0}),Ge={"-1":"asc",1:"desc"},Qe=g((()=>({sort_dir:Ge[De.value.activeSort],sort:De.value.sortBy}))),qe=g((()=>[{label:`${Se("token")}/${Se("balance1")}`,value:"balance_usd",flex:"flex-[1.5]",sort:!0},{label:Se("profit2"),value:"total_profit",flex:"flex-1 justify-end",sort:!0},{label:"",value:"",flex:"flex-1 justify-end",sort:!1}])),Je=c({finished:!1,loading:!1,pageNo:1,pageSize:20}),Ke=c([]);async function Xe(){try{Je.value.loading=!0;const e=Je.value.pageNo,a=await N({pageNO:Je.value.pageNo,pageSize:Je.value.pageSize,...Me.value,...Qe.value});if(Array.isArray(null==a?void 0:a.data)&&a.data.length>0){if(1===e)Ke.value=a.data.map((e=>{var a;return{...e,index:e.token===b?(null==(a=x(e.chain))?void 0:a.wmain_wrapper)+"-"+e.chain:`${e.token}-${e.chain}`}}));else{const e=a.data.filter((e=>Ke.value.every((a=>a.index!==`${e.token}-${e.chain}`)))).map((e=>{var a;return{...e,index:e.token===b?(null==(a=x(e.chain))?void 0:a.wmain_wrapper)+"-"+e.chain:`${e.token}-${e.chain}`}}));Ke.value=Ke.value.concat(e)}Je.value.finished=a.data.length<Je.value.pageSize,Je.value.finished||Je.value.pageNo++}else 1===Je.value.pageNo&&(Ke.value=[]);Ce.setMultiPriceParams("positions",Ke.value.map((e=>e.token+"-"+e.chain))),Ce.sendPriceWs()}catch(e){}finally{Je.value.loading=!1,m(Je)}}async function Ye(e){if(!Y())return;if(!e.token)return;const a=$e.getWalletAddress(e.chain);if(a)try{Oe.value[e.index]=!0;const s=(await _({chain:e.chain,tokens:[e.token],walletAddress:a}))[0];s&&(e.balance=s.balance||0,e.balance_usd=new p(s.balance||0).times(e.current_price_usd||0).toNumber(),e.decimals=s.decimals||e.decimals);const t=s.balance||0;if(!t)return void Z({title:"Error",type:"error",message:s("insufficientBalance")});await Fe.checkApproveAndApprove({chain:e.chain,token:e.token,owner:a}),function(e,a){var s;if(!Y())return;if(new p(e||0).lte(0))return void Z({title:"Error",type:"error",message:Se("amountMustG0")});const t=null==(s=new p(e||0).toFixed().match(new RegExp(`[0-9]*(\\.[0-9]{0,${a.decimals||18}})?`)))?void 0:s[0];if((Number(t)||0)<=0)return void Z({title:"Error",type:"error",message:Se("amountTooSmall")});Oe.value[a.index]=!0,async function(e,a){var s,t,l,i,o;const n="solana"===a.chain,{botSettings:r}=Ae,u=null==(t=null==(s=null==r?void 0:r[a.chain])?void 0:s.sell)?void 0:t.selected,c=null==(i=null==(l=null==r?void 0:r[a.chain])?void 0:l.sell)?void 0:i[u];if(n&&(null==c?void 0:c.mev)&&!(await $e.getBundleAvailable()))return void(Oe.value[a.index]=!1);const{gasTip1List:m,gasTip2List:v}=ee(ae().gasTip,"solana"),f=(null==c?void 0:c.mev)?m:v,h=(null==c?void 0:c.mev)?null==c?void 0:c.gas[0]:null==(o=null==c?void 0:c.gas)?void 0:o[1];let _={};if(n){let e=(null==h?void 0:h.customFee)||(null==f?void 0:f[null==h?void 0:h.level])||"0.002";(null==c?void 0:c.mev)&&new p(e).lt("0.002")&&(e="0.002"),_.priorityFee=new p(e).times(10**9).toFixed(0)}else{const e=0===Number(null==h?void 0:h.customFee)?"0":(null==h?void 0:h.customFee)||(null==f?void 0:f[null==h?void 0:h.level])||"3";_.gasTip=Number(new p(e).times(10**9).toFixed(0)),_.contractType=0,_.chain=a.chain}const g={solana:"sol",ton:"TON"}[a.chain]||b,x=(null==c?void 0:c.slippage)||"9",k=$e.getWalletAddress(a.chain);if(!k)return;const w=Date.now().toString();_={..._,swapList:[{batchId:w,creatorAddress:k,inAmount:new p(e||0).times(10**a.decimals||0).toFixed(0)}],inTokenAddress:a.token,outTokenAddress:g,swapType:2,isPrivate:(null==c?void 0:c.mev)||!1,slippage:"auto"!==x?Number(new p(x).times(100).toFixed(0)):900};let y=se;n?y=le:"ton"===a.chain&&(y=ie);y(_).then((e=>function(e,a,s,t){if(e){let l=setTimeout((()=>{Z({type:"success",message:Se("transactionsSubmitted")}),Ie.placeOrderUpdate++,Oe.value[s]=!1}),500);const i=(null==t?void 0:t.chain)||"",o=(null==e?void 0:e[0])||{},n={solana:"/botapi/swap/createSolTx",ton:"/botapi/swap/createSwapTonTx"};ue({txInfo:o,chain:i,destination:(null==n?void 0:n[i])||"/botapi/swap/createSwapEvmTx",type:10});const r={[null==o?void 0:o.batchId]:null==o?void 0:o.id},u=d((()=>Te.wsResult.tgbot),(e=>{var t,i,o,n,d;const c=e.batchId;if(c===a){if(l&&(clearTimeout(l),l=null),Ie.placeOrderSuccess++,null==(i=null==(t=null==e?void 0:e.txList)?void 0:t[0])?void 0:i.success){Z({type:"success",message:Se("tradeSuccess")});const a=null==(o=null==e?void 0:e.txList)?void 0:o[0];de({...a,chain:null==e?void 0:e.chain},(null==r?void 0:r[c])||"")}else te((null==(d=null==(n=null==e?void 0:e.txList)?void 0:n[0])?void 0:d.failMessage)||"swap error");u(),Oe.value[s]=!1}}))}}(e,w,a.index,a))).catch((e=>{te(e||"swap error"),Oe.value[a.index]=!1}))}(e,a)}(t,e)}finally{Oe.value[e.index]=!1}}return y((()=>{Xe()})),d((()=>[Qe.value,Me.value.hide_risk,Me.value.hide_small,$e.evmAddress,()=>Ee.address,()=>Ee.walletSignature[Ee.address]]),(()=>{We(),Xe()})),(e,a)=>{const s=z,t=oe,l=L,i=B,o=H,n=q,r=U,u=K,d=ne,c=X,p=S;return j(($(),A("div",null,[F("div",me,[C(s,{modelValue:T(Me).hide_risk,"onUpdate:modelValue":a[0]||(a[0]=e=>T(Me).hide_risk=e),class:"ml-12px",style:{marginRight:0},size:"small","true-value":1,"false-value":0},{default:R((()=>[P(W(e.$t("hideRiskTokenShort")),1)])),_:1},8,["modelValue"]),C(s,{modelValue:T(Me).hide_small,"onUpdate:modelValue":a[1]||(a[1]=e=>T(Me).hide_small=e),size:"small","true-value":1,"false-value":0},{default:R((()=>[P(W(e.$t("hideSmallAssets1")+"<1USD"),1)])),_:1},8,["modelValue"]),T($e).evmAddress||T(Ee).address&&T(ze)&&"WatchWallet"!==T(Ee).walletName?($(),E(t,{key:0,userIds:T(Me).user_ids,"onUpdate:userIds":[a[2]||(a[2]=e=>T(Me).user_ids=e),a[3]||(a[3]=e=>{We(),Xe()})]},null,8,["userIds"])):I("",!0)]),C(re,{sort:T(De),"onUpdate:sort":a[4]||(a[4]=e=>V(De)?De.value=e:null),columns:T(qe)},null,8,["sort","columns"]),C(d,{height:T(Be)},{default:R((()=>[j(($(),A("div",{ref_key:"scrollContainerRef",ref:Le,"infinite-scroll-disabled":T(Je).finished||T(Je).loading,"infinite-scroll-distance":"200","infinite-scroll-delay":10,"infinite-scroll-immediate":!1},[F("div",fe,[($(!0),A(M,null,O(T(Ke),((a,s)=>($(),E(r,{key:s,class:"text-12px flex justify-between pl-10px py-10px cursor-pointer hover:bg-[--dialog-bg]",to:`/token/${a.index}`},{default:R((()=>[F("div",be,[C(i,{"popper-class":"tooltip-pd-0",placement:"bottom-start","show-arrow":!1},{default:R((()=>[C(l,{row:a},null,8,["row"])])),content:R((()=>[C(l,{row:a,"chain-class":"hidden","token-class":"w-240px h-240px [&&]:mr-0 rounded-16px"},null,8,["row"])])),_:2},1024),F("div",he,[F("div",_e,[F("span",ge,W(a.symbol),1),a.risk_score>55||a.risk_level<0?($(),E(o,{key:0,name:"custom:danger",class:"font-14 ml-2px color-#F72121"})):I("",!0)]),F("div",xe,[0===a.balance?($(),A(M,{key:0},[P("$0")],64)):"--"===a.balance?($(),A(M,{key:1},[P("--")],64)):($(),A(M,{key:2},[P(W(("formatNumber"in e?e.formatNumber:T(D))(a.balance,2))+"("+W("$"+("formatNumber"in e?e.formatNumber:T(D))(a.balance_usd||0,2))+") ",1)],64))])])]),F("div",ke,[F("div",{class:G(("getColorClass"in e?e.getColorClass:T(Q))(a.total_profit))},[0===Number(a.total_profit)?($(),A(M,{key:0},[P("0")],64)):"--"===a.total_profit?($(),A(M,{key:1},[P("--")],64)):($(),A(M,{key:2},[P(W(Number(a.total_profit)>0?"$":"-$")+W(("formatNumber"in e?e.formatNumber:T(D))(Math.abs(Number(a.total_profit)),2)),1)],64))],2),F("div",{class:G(("getColorClass"in e?e.getColorClass:T(Q))(a.total_profit_ratio))},[0===Number(a.total_profit_ratio)?($(),A(M,{key:0},[P("0")],64)):"--"===a.total_profit_ratio?($(),A(M,{key:1},[P("--")],64)):($(),A(M,{key:2},[P(W(Number(a.total_profit_ratio)>0?"+":"-")+W(("formatNumber"in e?e.formatNumber:T(D))(Math.abs(100*Number(a.total_profit_ratio)),2))+"% ",1)],64))],2)]),F("div",we,[T($e).evmAddress&&"0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"!==a.token?($(),E(n,{key:0,size:"small",loading:T(Oe)[a.index],class:"[--el-border:0] [&&]:[--el-button-bg-color:--d-222-l-F2F2F2] [&&]:font-normal",style:{padding:"4px"},onClick:J((e=>Ye(a)),["stop","prevent"])},{default:R((()=>[P(W(e.$t("closePosition")),1)])),_:2},1032,["loading","onClick"])):($(),A("span",ye,"--"))])])),_:2},1032,["to"])))),128)),0!==T(Ke).length||T(Je).loading?I("",!0):($(),E(u,{key:0}))]),T(Je).loading&&1!==T(Je).pageNo?($(),A("div",Ne,W(e.$t("loading")),1)):I("",!0)],8,ve)),[[c,Xe]])])),_:1},8,["height"])])),[[p,T(Je).loading&&1===T(Je).pageNo]])}}});export{je as default};
